---
/**
 * Blog Listing Page
 * 
 * Displays all published blog posts in a grid, sorted by date (newest first).
 */

import { getCollection, getEntry } from 'astro:content';
import BaseLayout from '@templates/BaseLayout.astro';
import Blog1 from '@organisms/Blog1.astro';
import Hero1 from '@organisms/Hero1.astro';

// Get all non-draft blog posts, sorted by date
const allPosts = await getCollection('blog', ({ data }) => {
  return data.draft !== true;
});

const sortedPosts = allPosts.sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Helper to get clean slug from category id
const getCategorySlug = (id: string) => id.replace(/\.md$/, '');

// Resolve category references for each post
const postsWithCategories = await Promise.all(
  sortedPosts.map(async (post) => {
    const category = await getEntry(post.data.category);
    return {
      slug: post.slug,
      data: post.data,
      category: category ? {
        slug: getCategorySlug(category.id),
        data: category.data,
      } : undefined,
    };
  })
);
---

<BaseLayout 
  title="Blog" 
  description="Read our latest articles, tutorials, and updates."
>
  <main>
    <Hero1
      tagline="Our Blog"
      heading="Latest Articles"
      description="Explore tutorials, news, tips, and insights from our team."
      size="sm"
      background="muted"
    />

    <Blog1
      posts={postsWithCategories}
      columns={3}
      cardVariant="elevated"
      size="lg"
    />
  </main>
</BaseLayout>
